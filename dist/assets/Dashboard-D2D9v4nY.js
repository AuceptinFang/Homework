import{d as e,r as a,o as t,a as l,c as i,b as r,w as o,e as s,f as n,E as u,t as d,g as p,h as c,v as m,k as f,l as y,m as g,F as v,n as b,x as h,y as _,u as w,q as F}from"./index-C61FNJK8.js";const k={class:"dashboard-container"},T={class:"header-content"},x={class:"user-info"},C={key:1,class:"loading-container"},D={key:2},B={class:"el-upload__tip"},P={class:"dialog-footer"},$=F(e({__name:"Dashboard",setup(e){const F=w(),$=a(localStorage.getItem("username")||""),S=a(!1),I=a(null),V=a(),U=a([]),q=a([]),z=a("checking"),A=a(!0),M=async()=>{var e,a;try{const e=await n.get("/submissions/user");q.value=e.data}catch(t){u.error((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.error)||"获取提交记录失败")}},O=async()=>{A.value=!0;try{if(!(await(async()=>{try{return await n.get("/health",{timeout:5e3}),z.value="online",d(!1),!0}catch(e){return z.value="offline",d(!0),!1}})())){const e=localStorage.getItem("cachedAssignments");return e&&(U.value=JSON.parse(e),u.warning("显示的是缓存数据，可能不是最新的")),void(A.value=!1)}const e=await n.get("/assignments");U.value=e.data,localStorage.setItem("cachedAssignments",JSON.stringify(e.data))}catch(e){if(e.response)u.error("获取作业列表失败");else{z.value="offline",d(!0);const e=localStorage.getItem("cachedAssignments");e&&(U.value=JSON.parse(e),u.warning("显示的是缓存数据，可能不是最新的"))}}finally{A.value=!1}};t((()=>{O(),M()}));const R=l({file:null,imageFiles:[],otherFile:null,description:"",submitType:"pdf"}),E=()=>{_.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{localStorage.removeItem("token"),localStorage.removeItem("isAdmin"),localStorage.removeItem("username"),F.push("/")}))},L=e=>{I.value=e,R.file=null,R.imageFiles=[],R.otherFile=null,R.description="",R.submitType="pdf",S.value=!0},j=e=>{if(e.raw){if("application/pdf"!==e.raw.type)return u.error("只能上传PDF文件！"),!1;R.file=e.raw}},J=(e,a)=>{if(e.raw&&!e.raw.type.startsWith("image/"))return u.error("只能上传图片文件！"),!1;R.imageFiles=a.map((e=>e.raw)).filter(Boolean)},N=e=>{if(e.raw){if(e.raw.size>20971520)return u.error("文件大小不能超过20MB！"),!1;R.otherFile=e.raw}},W=async()=>{V.value&&(I.value?"pdf"!==R.submitType||R.file?"images"!==R.submitType||0!==R.imageFiles.length?"other"!==R.submitType||R.otherFile?await V.value.validate((async e=>{var a;if(e)try{if(!I.value)return;const e=I.value.id,a=(I.value.title,"pdf"===I.value.fileFormat),t=new FormData;if("pdf"===R.submitType){const a=R.file;if(!a)return;if("application/pdf"!==a.type)return void u.error("只能上传PDF文件");if(a.size>20971520)return void u.error("文件大小不能超过20MB");t.append("file",a),R.description&&t.append("description",R.description);const l=await n.post(`/submissions/assignment/${e}`,t,{headers:{"Content-Type":"multipart/form-data"},timeout:3e4});q.value.unshift(l.data)}else if("images"===R.submitType){const l=R.imageFiles;if(l.reduce(((e,a)=>e+a.size),0)>20971520)return void u.error("文件总大小不能超过20MB");l.forEach((e=>{t.append("files",e)})),R.description&&t.append("description",R.description);let i=a?`/submissions/assignment/${e}/images`:`/submissions/assignment/${e}/raw-images`;const r=await n.post(i,t,{headers:{"Content-Type":"multipart/form-data"},timeout:a?6e4:3e4});q.value.unshift(r.data)}else if("other"===R.submitType){const a=R.otherFile;if(!a)return;if(a.size>20971520)return void u.error("文件大小不能超过20MB");t.append("file",a),R.description&&t.append("description",R.description);const l=await n.post(`/submissions/assignment/${e}/other`,t,{headers:{"Content-Type":"multipart/form-data"},timeout:3e4});q.value.unshift(l.data)}u.success("作业提交成功！"),S.value=!1,O(),M()}catch(t){if(t.response){const e=(null==(a=t.response.data)?void 0:a.error)||"提交作业失败";u.error(e)}else t.request?u.error("服务器未响应，请检查网络连接"):u.error(`请求错误: ${t.message}`)}else u.error("请填写完整的表单")})):u.error("请选择要上传的文件"):u.error("请选择要上传的图片文件"):u.error("请选择要上传的PDF文件"):u.error("当前作业不存在"))};return(e,a)=>{var t;const l=s("el-button"),d=s("el-header"),w=s("el-alert"),F=s("el-skeleton"),M=s("el-table-column"),O=s("el-table"),G=s("el-card"),H=s("el-col"),K=s("el-tag"),Q=s("el-row"),X=s("el-main"),Y=s("el-container"),Z=s("el-radio"),ee=s("el-radio-group"),ae=s("el-form-item"),te=s("el-upload"),le=s("el-icon"),ie=s("el-input"),re=s("el-form"),oe=s("el-dialog");return p(),i("div",k,[r(Y,null,{default:o((()=>[r(d,null,{default:o((()=>[c("div",T,[a[5]||(a[5]=c("h2",null,"作业提交系统",-1)),c("div",x,[c("span",null,m($.value),1),r(l,{type:"text",onClick:E},{default:o((()=>a[4]||(a[4]=[f("退出登录")]))),_:1})])])])),_:1}),r(X,null,{default:o((()=>["offline"===z.value?(p(),y(w,{key:0,title:"服务器连接失败，数据可能不是最新的",type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}})):g("",!0),A.value?(p(),i("div",C,[r(F,{rows:3,animated:""})])):(p(),i("div",D,[r(Q,{gutter:20},{default:o((()=>[r(H,{span:24,style:{"margin-bottom":"20px"}},{default:o((()=>[r(G,null,{header:o((()=>a[6]||(a[6]=[c("div",{class:"card-header"},[c("span",null,"可提交的作业")],-1)]))),default:o((()=>[r(O,{data:U.value,style:{width:"100%"}},{default:o((()=>[r(M,{prop:"title",label:"作业标题"}),r(M,{prop:"description",label:"作业描述"}),r(M,{prop:"deadline",label:"截止时间"}),r(M,{label:"操作"},{default:o((({row:e})=>[r(l,{type:"primary",onClick:a=>L(e)},{default:o((()=>a[7]||(a[7]=[f("提交作业")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1})])),_:1}),r(H,{span:24},{default:o((()=>[r(G,null,{header:o((()=>a[8]||(a[8]=[c("div",{class:"card-header"},[c("span",null,"提交记录")],-1)]))),default:o((()=>[r(O,{data:q.value,style:{width:"100%"}},{default:o((()=>[r(M,{prop:"title",label:"作业标题"}),r(M,{prop:"submitTime",label:"提交时间"}),r(M,{prop:"originalFilename",label:"文件名"},{default:o((({row:e})=>[f(m(e.originalFilename||"未知文件名"),1)])),_:1}),r(M,{prop:"status",label:"状态"},{default:o((({row:e})=>[r(K,{type:"submitted"===e.status?"success":"info"},{default:o((()=>[f(m("submitted"===e.status?"已提交":"未提交"),1)])),_:2},1032,["type"])])),_:1}),r(M,{label:"操作"},{default:o((({row:e})=>[r(l,{type:"primary",onClick:a=>(async e=>{var a,t;try{let a=(await n.get(`/submissions/${e.id}`)).data.originalFilename||`作业-${e.id}.pdf`;a&&""!==a.trim()||(a=`作业-${e.id}.pdf`);const t=u.info({message:"正在下载文件...",duration:0}),l=await fetch(`/submissions/${e.id}/file`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!l.ok)throw new Error(`下载失败: ${l.status} ${l.statusText}`);const i=await l.blob();t.close();const r=window.URL.createObjectURL(i),o=document.createElement("a");o.href=r,o.download=a,document.body.appendChild(o),o.click(),window.URL.revokeObjectURL(r),document.body.removeChild(o),u.success("文件下载成功")}catch(l){l.response,u.error((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.error)||l.message||"下载文件失败")}})(e)},{default:o((()=>a[9]||(a[9]=[f("查看")]))),_:2},1032,["onClick"]),r(l,{type:"warning",onClick:a=>(e=>{const a=U.value.find((a=>a.id===e.assignmentId));a?_.confirm("重新提交将会删除您之前提交的文件，确定要继续吗？","确认重新提交",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{L(a)})).catch((()=>{u.info("已取消重新提交")})):u.warning("该作业已不允许提交")})(e)},{default:o((()=>a[10]||(a[10]=[f("重新提交")]))),_:2},1032,["onClick"]),r(l,{type:"danger",onClick:a=>(async e=>{_.confirm("确定要删除这个作业吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{var a,t;try{await n.delete(`/submissions/${e.id}`),q.value=q.value.filter((a=>a.id!==e.id)),u.success("删除成功")}catch(l){u.error((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.error)||"删除作业失败")}}))})(e)},{default:o((()=>a[11]||(a[11]=[f("删除")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1})])),_:1})])),_:1})]))])),_:1})])),_:1}),r(oe,{modelValue:S.value,"onUpdate:modelValue":a[3]||(a[3]=e=>S.value=e),title:null==(t=I.value)?void 0:t.title,width:"50%"},{footer:o((()=>[c("span",P,[r(l,{onClick:a[2]||(a[2]=e=>S.value=!1)},{default:o((()=>a[23]||(a[23]=[f("取消")]))),_:1}),r(l,{type:"primary",onClick:W},{default:o((()=>a[24]||(a[24]=[f(" 提交 ")]))),_:1})])])),default:o((()=>[r(re,{ref_key:"submitFormRef",ref:V,model:R,"label-width":"120px"},{default:o((()=>{var e;return["pdf"===(null==(e=I.value)?void 0:e.fileFormat)?(p(),y(w,{key:0,type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}},{default:o((()=>a[12]||(a[12]=[c("p",null,"此作业要求提交PDF格式文件。您可以：",-1),c("ul",null,[c("li",null,"直接上传PDF文件"),c("li",null,"上传多张图片，系统将自动合并为PDF")],-1)]))),_:1})):(p(),y(w,{key:1,type:"info",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}},{default:o((()=>a[13]||(a[13]=[c("p",null,"此作业允许提交任意格式文件，无需转换为PDF。",-1)]))),_:1})),r(ae,{label:"提交类型",prop:"submitType"},{default:o((()=>[r(ee,{modelValue:R.submitType,"onUpdate:modelValue":a[0]||(a[0]=e=>R.submitType=e)},{default:o((()=>{var e;return["pdf"===(null==(e=I.value)?void 0:e.fileFormat)?(p(),i(v,{key:0},[r(Z,{label:"pdf"},{default:o((()=>a[14]||(a[14]=[f("PDF文件")]))),_:1}),r(Z,{label:"images"},{default:o((()=>a[15]||(a[15]=[f("多张图片")]))),_:1})],64)):(p(),i(v,{key:1},[r(Z,{label:"pdf"},{default:o((()=>a[16]||(a[16]=[f("PDF文件")]))),_:1}),r(Z,{label:"images"},{default:o((()=>a[17]||(a[17]=[f("图片文件")]))),_:1}),r(Z,{label:"other"},{default:o((()=>a[18]||(a[18]=[f("其他格式")]))),_:1})],64))]})),_:1},8,["modelValue"])])),_:1}),"pdf"===R.submitType?(p(),y(ae,{key:2,label:"PDF文件",prop:"file",rules:[{required:"pdf"===R.submitType,message:"请上传PDF文件"}]},{default:o((()=>[r(te,{class:"upload-container","auto-upload":!1,limit:1,accept:".pdf","on-change":j},{trigger:o((()=>[r(l,{type:"primary",class:"upload-button"},{default:o((()=>a[19]||(a[19]=[f("选择文件")]))),_:1})])),tip:o((()=>a[20]||(a[20]=[c("div",{class:"el-upload__tip"}," 只能上传 PDF 文件 ",-1)]))),_:1})])),_:1},8,["rules"])):g("",!0),"images"===R.submitType?(p(),y(ae,{key:3,label:"图片文件",prop:"imageFiles",rules:[{required:"images"===R.submitType,message:"请上传至少一张图片"}]},{default:o((()=>[r(te,{class:"upload-container","auto-upload":!1,limit:10,multiple:"",accept:"image/*","list-type":"picture-card","on-change":J},{tip:o((()=>{var e;return[c("div",B,m("pdf"===(null==(e=I.value)?void 0:e.fileFormat)?"可上传多张图片，将自动合并为PDF（最多10张）":"可上传多张图片（最多10张）"),1)]})),default:o((()=>[r(le,null,{default:o((()=>[r(b(h))])),_:1})])),_:1})])),_:1},8,["rules"])):g("",!0),"other"===R.submitType?(p(),y(ae,{key:4,label:"其他文件",prop:"otherFile",rules:[{required:"other"===R.submitType,message:"请上传文件"}]},{default:o((()=>[r(te,{class:"upload-container","auto-upload":!1,limit:1,"on-change":N},{trigger:o((()=>[r(l,{type:"primary",class:"upload-button"},{default:o((()=>a[21]||(a[21]=[f("选择文件")]))),_:1})])),tip:o((()=>a[22]||(a[22]=[c("div",{class:"el-upload__tip"}," 文件大小不超过20MB ",-1)]))),_:1})])),_:1},8,["rules"])):g("",!0),r(ae,{label:"备注",prop:"description"},{default:o((()=>[r(ie,{modelValue:R.description,"onUpdate:modelValue":a[1]||(a[1]=e=>R.description=e),type:"textarea",placeholder:"请输入备注信息（可选）"},null,8,["modelValue"])])),_:1})]})),_:1},8,["model"])])),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-9e0cb28f"]]);export{$ as default};
