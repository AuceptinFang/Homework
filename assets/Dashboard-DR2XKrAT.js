import{d as oe,r as g,o as te,a as ne,c as T,b as t,w as n,e as i,f as b,E as a,t as R,h as m,v as V,k as f,l as le,m as se,x as F,u as ae,g as I,q as re}from"./index-Cvb4EdU9.js";const ie={class:"dashboard-container"},ce={class:"header-content"},de={class:"user-info"},ue={key:1,class:"loading-container"},pe={key:2},me={class:"dialog-footer"},fe=oe({__name:"Dashboard",setup(ge){const z=ae(),E=g(localStorage.getItem("username")||""),w=g(!1),y=g(null),B=g(),h=g([]),k=g([]),S=g("checking"),$=g(!0),A=async()=>{var l,e,o,r;try{console.log("开始获取提交记录...");const s=await b.get("/api/submissions/user");console.log("获取提交记录成功:",s.data),k.value=s.data}catch(s){console.error("获取提交记录失败:",s),console.error("错误详情:",(l=s.response)==null?void 0:l.data),console.error("错误状态:",(e=s.response)==null?void 0:e.status),a.error(((r=(o=s.response)==null?void 0:o.data)==null?void 0:r.error)||"获取提交记录失败")}},M=async()=>{try{return await b.get("/api/health",{timeout:5e3}),S.value="online",R(!1),!0}catch(l){return console.error("服务器连接检查失败:",l),S.value="offline",R(!0),!1}},O=async()=>{$.value=!0;try{if(!await M()){const o=localStorage.getItem("cachedAssignments");o&&(h.value=JSON.parse(o),a.warning("显示的是缓存数据，可能不是最新的")),$.value=!1;return}const e=await b.get("/api/assignments");h.value=e.data,localStorage.setItem("cachedAssignments",JSON.stringify(e.data))}catch(l){if(l.response)a.error("获取作业列表失败");else{S.value="offline",R(!0);const e=localStorage.getItem("cachedAssignments");e&&(h.value=JSON.parse(e),a.warning("显示的是缓存数据，可能不是最新的"))}}finally{$.value=!1}};te(()=>{O(),A()});const p=ne({file:null,description:""}),P=()=>{F.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{localStorage.removeItem("token"),localStorage.removeItem("isAdmin"),localStorage.removeItem("username"),z.push("/")})},L=l=>{y.value=l,p.file=null,p.description="",w.value=!0},q=l=>{const e=h.value.find(o=>o.id===l.assignmentId);e?F.confirm("重新提交将会删除您之前提交的文件，确定要继续吗？","确认重新提交",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{console.log("用户确认重新提交作业:",e.title),L(e)}).catch(()=>{console.log("用户取消重新提交"),a.info("已取消重新提交")}):a.warning("该作业已不允许提交")},H=l=>{if(l.raw){if(l.raw.type!=="application/pdf")return a.error("只能上传PDF文件！"),!1;p.file=l.raw}},J=async()=>{if(!B.value){console.error("表单引用不存在");return}if(!y.value){console.error("当前作业不存在"),a.error("当前作业不存在");return}if(!p.file){console.error("未选择文件"),a.error("请选择要上传的文件");return}await B.value.validate(async l=>{var e;if(l)try{if(console.log("开始提交作业..."),!y.value||!p.file)return;const o=y.value.id,r=y.value.title,s=p.file;if(console.log("作业ID:",o),console.log("作业标题:",r),console.log("文件名:",s.name),console.log("文件大小:",s.size),console.log("文件类型:",s.type),s.type!=="application/pdf"){console.error("文件类型错误:",s.type),a.error("只能上传PDF文件");return}if(s.size>20*1024*1024){console.error("文件过大:",s.size),a.error("文件大小不能超过20MB");return}const u=new FormData;u.append("file",s),p.description&&u.append("description",p.description),console.log("发送请求..."),console.log("请求URL:",`/api/submissions/assignment/${o}`),console.log("请求方法: POST"),console.log("请求头:",{"Content-Type":"multipart/form-data",Authorization:`Bearer ${localStorage.getItem("token")}`});const d=await b.post(`/api/submissions/assignment/${o}`,u,{headers:{"Content-Type":"multipart/form-data"},timeout:3e4});console.log("提交作业成功:",d.data),k.value.unshift(d.data),a.success("作业提交成功！"),w.value=!1,O(),A()}catch(o){if(console.error("提交作业失败:",o),o.response){console.error("错误状态:",o.response.status),console.error("错误数据:",o.response.data);const r=((e=o.response.data)==null?void 0:e.error)||"提交作业失败";a.error(r)}else o.request?(console.error("请求未收到响应:",o.request),a.error("服务器未响应，请检查网络连接")):(console.error("请求配置错误:",o.message),a.error(`请求错误: ${o.message}`))}else console.error("表单验证失败"),a.error("请填写完整的表单")})},j=async l=>{var e,o;try{console.log("查看提交的作业:",l),console.log("文件ID:",l.id),console.log("获取提交记录详情...");const s=(await b.get(`/api/submissions/${l.id}`)).data;console.log("提交记录详情:",s);let u=s.originalFilename||`作业-${l.id}.pdf`;(!u||u.trim()==="")&&(u=`作业-${l.id}.pdf`),console.log("原始文件名:",u),console.log("文件路径:",s.filePath||"");const d=a.info({message:"正在下载文件...",duration:0});console.log("开始下载文件..."),console.log("请求URL:",`/api/submissions/${l.id}/file`);const _=await fetch(`/api/submissions/${l.id}/file`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!_.ok)throw new Error(`下载失败: ${_.status} ${_.statusText}`);const x=await _.blob();console.log("文件下载成功，大小:",x.size),d.close();const C=window.URL.createObjectURL(x),v=document.createElement("a");v.href=C,v.download=u,console.log("设置下载文件名:",u),document.body.appendChild(v),v.click(),window.URL.revokeObjectURL(C),document.body.removeChild(v),a.success("文件下载成功")}catch(r){console.error("查看作业失败:",r),r.response&&(console.error("错误状态:",r.response.status),console.error("错误数据:",r.response.data)),a.error(((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.error)||r.message||"下载文件失败")}},G=async l=>{F.confirm("确定要删除这个作业吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var e,o;try{await b.delete(`/api/submissions/${l.id}`),k.value=k.value.filter(r=>r.id!==l.id),a.success("删除成功")}catch(r){a.error(((o=(e=r.response)==null?void 0:e.data)==null?void 0:o.error)||"删除作业失败")}})};return(l,e)=>{var N;const o=i("el-button"),r=i("el-header"),s=i("el-alert"),u=i("el-skeleton"),d=i("el-table-column"),_=i("el-table"),x=i("el-card"),C=i("el-col"),v=i("el-tag"),K=i("el-row"),Q=i("el-main"),W=i("el-container"),X=i("el-upload"),U=i("el-form-item"),Y=i("el-input"),Z=i("el-form"),ee=i("el-dialog");return I(),T("div",ie,[t(W,null,{default:n(()=>[t(r,null,{default:n(()=>[m("div",ce,[e[4]||(e[4]=m("h2",null,"作业提交系统",-1)),m("div",de,[m("span",null,V(E.value),1),t(o,{type:"text",onClick:P},{default:n(()=>e[3]||(e[3]=[f("退出登录")])),_:1})])])]),_:1}),t(Q,null,{default:n(()=>[S.value==="offline"?(I(),le(s,{key:0,title:"服务器连接失败，数据可能不是最新的",type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}})):se("",!0),$.value?(I(),T("div",ue,[t(u,{rows:3,animated:""})])):(I(),T("div",pe,[t(K,{gutter:20},{default:n(()=>[t(C,{span:24,style:{"margin-bottom":"20px"}},{default:n(()=>[t(x,null,{header:n(()=>e[5]||(e[5]=[m("div",{class:"card-header"},[m("span",null,"可提交的作业")],-1)])),default:n(()=>[t(_,{data:h.value,style:{width:"100%"}},{default:n(()=>[t(d,{prop:"title",label:"作业标题"}),t(d,{prop:"description",label:"作业描述"}),t(d,{prop:"deadline",label:"截止时间"}),t(d,{label:"操作"},{default:n(({row:c})=>[t(o,{type:"primary",onClick:D=>L(c)},{default:n(()=>e[6]||(e[6]=[f("提交作业")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),t(C,{span:24},{default:n(()=>[t(x,null,{header:n(()=>e[7]||(e[7]=[m("div",{class:"card-header"},[m("span",null,"提交记录")],-1)])),default:n(()=>[t(_,{data:k.value,style:{width:"100%"}},{default:n(()=>[t(d,{prop:"title",label:"作业标题"}),t(d,{prop:"submitTime",label:"提交时间"}),t(d,{prop:"originalFilename",label:"文件名"},{default:n(({row:c})=>[f(V(c.originalFilename||"未知文件名"),1)]),_:1}),t(d,{prop:"status",label:"状态"},{default:n(({row:c})=>[t(v,{type:c.status==="submitted"?"success":"info"},{default:n(()=>[f(V(c.status==="submitted"?"已提交":"未提交"),1)]),_:2},1032,["type"])]),_:1}),t(d,{label:"操作"},{default:n(({row:c})=>[t(o,{type:"primary",onClick:D=>j(c)},{default:n(()=>e[8]||(e[8]=[f("查看")])),_:2},1032,["onClick"]),t(o,{type:"warning",onClick:D=>q(c)},{default:n(()=>e[9]||(e[9]=[f("重新提交")])),_:2},1032,["onClick"]),t(o,{type:"danger",onClick:D=>G(c)},{default:n(()=>e[10]||(e[10]=[f("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})]))]),_:1})]),_:1}),t(ee,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=c=>w.value=c),title:(N=y.value)==null?void 0:N.title,width:"50%"},{footer:n(()=>[m("span",me,[t(o,{onClick:e[1]||(e[1]=c=>w.value=!1)},{default:n(()=>e[13]||(e[13]=[f("取消")])),_:1}),t(o,{type:"primary",onClick:J},{default:n(()=>e[14]||(e[14]=[f(" 提交 ")])),_:1})])]),default:n(()=>[t(Z,{ref_key:"submitFormRef",ref:B,model:p,"label-width":"120px"},{default:n(()=>[t(U,{label:"作业文件",prop:"file",rules:[{required:!0,message:"请上传作业文件"}]},{default:n(()=>[t(X,{class:"upload-container","auto-upload":!1,limit:1,accept:".pdf","on-change":H},{trigger:n(()=>[t(o,{type:"primary",class:"upload-button"},{default:n(()=>e[11]||(e[11]=[f("选择文件")])),_:1})]),tip:n(()=>e[12]||(e[12]=[m("div",{class:"el-upload__tip"}," 只能上传 PDF 文件 ",-1)])),_:1})]),_:1}),t(U,{label:"备注",prop:"description"},{default:n(()=>[t(Y,{modelValue:p.description,"onUpdate:modelValue":e[0]||(e[0]=c=>p.description=c),type:"textarea",placeholder:"请输入备注信息（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),ve=re(fe,[["__scopeId","data-v-6a8a7270"]]);export{ve as default};
