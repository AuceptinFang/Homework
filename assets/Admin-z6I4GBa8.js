import{d as ye,r as b,o as we,a as ke,z as A,c as he,b as t,w as l,e as r,f as w,E as u,h as f,v as _,k as m,l as O,m as Q,n as Ve,A as xe,x as G,u as Se,g as P,q as Ce}from"./index-Cvb4EdU9.js";const $e={class:"admin-container"},Be={class:"header-content"},Ie={class:"user-info"},Fe={class:"card-header"},De={class:"card-header"},Ue={class:"header-left"},Te={class:"submission-stats",style:{"margin-top":"20px"}},Le={class:"dialog-footer"},Re={class:"dialog-footer"},Ae=ye({__name:"Admin",setup(Me){const M=Se(),J=b(localStorage.getItem("username")||""),D=b(""),U=b(""),x=b(!1),S=b(!1),T=b(null),c=b(null),Y=b(),q=["admin","段鹏鹏","方震","高天全","高子涵","龚皓","霍雨婷","贾奇燠","贾一丁","金闿翎","靳宇晨","李希","刘森源","刘文晶","吕彦儒","吕泽熙","苏宗佑","汤锦健","王奕涵","王悦琳","王志成","王墨","王泽君","夏正鑫","肖俊波","杨海屹","杨孟涵","张成宇","张峻菘","张钟文","赵萌"],C=b([]),$=b([]),K=async()=>{var o,e;try{const n=await w.get("/api/assignments");C.value=n.data}catch(n){u.error(((e=(o=n.response)==null?void 0:o.data)==null?void 0:e.error)||"获取作业列表失败")}};we(()=>{K()});const d=ke({title:"",description:"",deadline:"",allowSubmit:!0,fileFormat:"pdf"}),W={title:[{required:!0,message:"请输入作业标题",trigger:"blur"},{min:2,max:50,message:"标题长度应在2到50个字符之间",trigger:"blur"}],description:[{required:!0,message:"请输入作业说明",trigger:"blur"}],deadline:[{required:!0,message:"请选择截止日期",trigger:"change"}]},k=b({content:""}),L=A(()=>c.value?(console.log("当前作业ID:",c.value.id),console.log("提交记录列表:",$.value),q.filter(e=>e!=="admin").map(e=>{const n=$.value.find(s=>{const i=typeof s.assignmentId=="string"?parseInt(s.assignmentId):s.assignmentId,p=typeof c.value.id=="string"?parseInt(c.value.id):c.value.id;let g=typeof s.submittedBy=="string"?s.submittedBy:"";const v=i===p&&g===e;return console.log(`检查用户 ${e} 的提交记录:`,{assignmentId:s.assignmentId,currentAssignmentId:c.value.id,submittedBy:g,match:v}),v});return n?(console.log(`用户 ${e} 已提交作业`),{...n,submittedBy:e}):(console.log(`用户 ${e} 未提交作业`),{id:0,assignmentId:c.value.id,title:c.value.title,submitTime:"-",status:"unsubmitted",file:null,submittedBy:e})}).filter(e=>{const n=typeof e.submittedBy=="string"?e.submittedBy:e.submittedBy||"",s=D.value===""||n.toLowerCase().includes(D.value.toLowerCase()),i=U.value===""||e.status===U.value;return s&&i})):[]),H=A(()=>L.value.filter(o=>o.status==="submitted").length),X=A(()=>L.value.filter(o=>o.status==="unsubmitted").length),Z=A(()=>{const o=L.value.length;return o>0?Math.round(H.value/o*100):0}),ee=o=>({submitted:"success",unsubmitted:"info"})[o]||"info",te=o=>({submitted:"已提交",unsubmitted:"未提交"})[o]||"未知",le=()=>{G.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{localStorage.removeItem("token"),localStorage.removeItem("isAdmin"),localStorage.removeItem("username"),M.push("/")})},oe=()=>{d.title="",d.description="",d.deadline="",d.allowSubmit=!0,d.fileFormat="pdf",x.value=!0},ae=o=>o.getTime()<Date.now(),ne=async()=>{Y.value&&await Y.value.validate(async o=>{var e,n;if(o)try{const s=d.deadline?d.deadline.replace(" ","T")+":00":null,i=await w.post("/api/assignments",{title:d.title,description:d.description,deadline:s,allowSubmit:d.allowSubmit,fileFormat:d.fileFormat});C.value.unshift(i.data),u.success("作业发布成功！"),x.value=!1}catch(s){console.error("发布作业失败:",s),u.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.error)||"发布作业失败，请检查网络连接")}})},se=async o=>{var e,n;try{await w.put(`/api/assignments/${o.id}/submit-control`,{allowSubmit:o.allowSubmit});const s=o.allowSubmit?"允许":"禁止";u.success(`已${s}作业提交`)}catch(s){u.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.error)||"更新提交控制失败"),o.allowSubmit=!o.allowSubmit}},ie=o=>{G.confirm("确定要删除这个作业吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var e,n,s;try{await w.delete(`/api/assignments/${o.id}`),C.value=C.value.filter(i=>i.id!==o.id),((e=c.value)==null?void 0:e.id)===o.id&&(c.value=null),u.success("删除成功")}catch(i){u.error(((s=(n=i.response)==null?void 0:n.data)==null?void 0:s.error)||"删除作业失败")}})},re=async o=>{var e;try{if(!(o!=null&&o.id)){u.error("无效的作业ID");return}if(!localStorage.getItem("token")){u.error("登录已过期，请重新登录"),M.push("/");return}console.log("正在获取作业提交情况:",{assignmentId:o.id,title:o.title});const s=await w.get(`/api/submissions/assignment/${o.id}`);console.log("获取提交情况成功:",s.data),$.value=s.data,c.value=o}catch(n){if(console.error("获取提交情况失败:",n),n.response){const s=n.response.status,i=((e=n.response.data)==null?void 0:e.error)||"未知错误";s===400?u.error(`请求参数错误: ${i}`):s===401?(u.error("登录已过期，请重新登录"),M.push("/")):s===403?u.error("没有权限查看此作业的提交情况"):s===404?u.error("作业不存在"):u.error(`获取提交情况失败: ${i}`)}else u.error("网络错误，请检查网络连接")}},de=async o=>{var e,n;try{console.log("查看提交的作业:",o),console.log("文件ID:",o.id),console.log("获取提交记录详情...");const i=(await w.get(`/api/submissions/${o.id}`)).data;console.log("提交记录详情:",i);let p=i.originalFilename||`作业-${o.id}.pdf`;(!p||p.trim()==="")&&(p=`${typeof o.submittedBy=="string"?o.submittedBy:""}-作业-${o.id}.pdf`),console.log("原始文件名:",p),console.log("文件路径:",i.filePath||"");const g=u.info({message:"正在下载文件...",duration:0});console.log("开始下载文件..."),console.log("请求URL:",`/api/submissions/${o.id}/file`);const v=await fetch(`/api/submissions/${o.id}/file`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!v.ok)throw new Error(`下载失败: ${v.status} ${v.statusText}`);const B=await v.blob();console.log("文件下载成功，大小:",B.size),g.close();const I=window.URL.createObjectURL(B),y=document.createElement("a");y.href=I,y.download=p,console.log("设置下载文件名:",p),document.body.appendChild(y),y.click(),window.URL.revokeObjectURL(I),document.body.removeChild(y),u.success("文件下载成功")}catch(s){console.error("查看作业失败:",s),s.response&&(console.error("错误状态:",s.response.status),console.error("错误数据:",s.response.data)),u.error(((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.error)||s.message||"下载文件失败")}},ue=o=>{T.value=o,k.value.content=o.feedback||"",S.value=!0},me=async()=>{var o,e;if(!k.value.content.trim()){u.warning("请输入反馈内容");return}if(T.value)try{const n=await w.put(`/api/submissions/${T.value.id}/feedback`,{feedback:k.value.content}),s=$.value.findIndex(i=>{var p;return i.id===((p=T.value)==null?void 0:p.id)});s!==-1&&($.value[s]=n.data),u.success("反馈已提交"),S.value=!1}catch(n){u.error(((e=(o=n.response)==null?void 0:o.data)==null?void 0:e.error)||"提交反馈失败")}};return(o,e)=>{const n=r("el-button"),s=r("el-header"),i=r("el-table-column"),p=r("el-tag"),g=r("el-switch"),v=r("el-table"),B=r("el-card"),I=r("el-col"),y=r("el-icon"),F=r("el-input"),E=r("el-option"),ce=r("el-select"),R=r("el-descriptions-item"),pe=r("el-descriptions"),fe=r("el-row"),be=r("el-main"),_e=r("el-container"),h=r("el-form-item"),ve=r("el-date-picker"),N=r("el-radio"),ge=r("el-radio-group"),z=r("el-form"),j=r("el-dialog");return P(),he("div",$e,[t(_e,null,{default:l(()=>[t(s,null,{default:l(()=>[f("div",Be,[e[13]||(e[13]=f("h2",null,"作业提交系统 - 管理员",-1)),f("div",Ie,[f("span",null,_(J.value),1),t(n,{type:"text",onClick:le},{default:l(()=>e[12]||(e[12]=[m("退出登录")])),_:1})])])]),_:1}),t(be,null,{default:l(()=>[t(fe,{gutter:20},{default:l(()=>[t(I,{span:24,style:{"margin-bottom":"20px"}},{default:l(()=>[t(B,null,{header:l(()=>[f("div",Fe,[e[15]||(e[15]=f("span",null,"作业发布管理",-1)),t(n,{type:"primary",onClick:oe},{default:l(()=>e[14]||(e[14]=[m(" 发布新作业 ")])),_:1})])]),default:l(()=>[t(v,{data:C.value,style:{width:"100%"}},{default:l(()=>[t(i,{prop:"title",label:"作业标题"}),t(i,{prop:"description",label:"作业说明","show-overflow-tooltip":""}),t(i,{prop:"deadline",label:"截止日期",width:"180"}),t(i,{prop:"createTime",label:"发布时间",width:"180"}),t(i,{label:"文件格式",width:"100"},{default:l(({row:a})=>[t(p,{type:a.fileFormat==="pdf"?"warning":"info"},{default:l(()=>[m(_(a.fileFormat==="pdf"?"仅PDF":"不限"),1)]),_:2},1032,["type"])]),_:1}),t(i,{label:"提交控制",width:"120"},{default:l(({row:a})=>[t(g,{modelValue:a.allowSubmit,"onUpdate:modelValue":V=>a.allowSubmit=V,"active-text":"允许","inactive-text":"禁止",onChange:V=>se(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(i,{label:"操作",width:"180"},{default:l(({row:a})=>[t(n,{type:"primary",link:"",onClick:V=>re(a)},{default:l(()=>e[16]||(e[16]=[m(" 查看提交情况 ")])),_:2},1032,["onClick"]),t(n,{type:"danger",link:"",onClick:V=>ie(a)},{default:l(()=>e[17]||(e[17]=[m(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),t(I,{span:24},{default:l(()=>[c.value?(P(),O(B,{key:0},{header:l(()=>[f("div",De,[f("div",Ue,[f("span",null,_(c.value.title)+" - 提交情况",1),t(p,{type:c.value.allowSubmit?"success":"danger",style:{"margin-left":"10px"}},{default:l(()=>[m(_(c.value.allowSubmit?"允许提交":"禁止提交"),1)]),_:1},8,["type"])]),f("div",null,[t(F,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=a=>D.value=a),placeholder:"搜索用户",style:{width:"200px","margin-right":"10px"}},{prefix:l(()=>[t(y,null,{default:l(()=>[t(Ve(xe))]),_:1})]),_:1},8,["modelValue"]),t(ce,{modelValue:U.value,"onUpdate:modelValue":e[1]||(e[1]=a=>U.value=a),placeholder:"状态筛选"},{default:l(()=>[t(E,{label:"全部",value:""}),t(E,{label:"已提交",value:"submitted"}),t(E,{label:"未提交",value:"unsubmitted"})]),_:1},8,["modelValue"])])])]),default:l(()=>[t(v,{data:L.value,style:{width:"100%"}},{default:l(()=>[t(i,{prop:"submittedBy",label:"用户",width:"120"},{default:l(({row:a})=>[m(_((typeof a.submittedBy=="string",a.submittedBy)),1)]),_:1}),t(i,{prop:"submitTime",label:"提交时间",width:"180"}),t(i,{prop:"originalFilename",label:"文件名",width:"180"},{default:l(({row:a})=>[m(_(a.originalFilename||(a.status==="submitted"?"未知文件名":"-")),1)]),_:1}),t(i,{prop:"status",label:"状态",width:"120"},{default:l(({row:a})=>[t(p,{type:ee(a.status)},{default:l(()=>[m(_(te(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(i,{label:"操作",width:"180"},{default:l(({row:a})=>[a.status==="submitted"?(P(),O(n,{key:0,type:"primary",link:"",onClick:V=>de(a)},{default:l(()=>e[18]||(e[18]=[m(" 查看作业 ")])),_:2},1032,["onClick"])):Q("",!0),t(n,{type:"warning",link:"",onClick:V=>ue(a)},{default:l(()=>e[19]||(e[19]=[m(" 添加反馈 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),f("div",Te,[t(pe,{column:4,border:""},{default:l(()=>[t(R,{label:"总人数"},{default:l(()=>[m(_(q.length),1)]),_:1}),t(R,{label:"已提交"},{default:l(()=>[m(_(H.value),1)]),_:1}),t(R,{label:"未提交"},{default:l(()=>[m(_(X.value),1)]),_:1}),t(R,{label:"提交率"},{default:l(()=>[m(_(Z.value)+"%",1)]),_:1})]),_:1})])]),_:1})):Q("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(j,{modelValue:x.value,"onUpdate:modelValue":e[8]||(e[8]=a=>x.value=a),title:"发布新作业",width:"500px"},{footer:l(()=>[f("span",Le,[t(n,{onClick:e[7]||(e[7]=a=>x.value=!1)},{default:l(()=>e[22]||(e[22]=[m("取消")])),_:1}),t(n,{type:"primary",onClick:ne},{default:l(()=>e[23]||(e[23]=[m(" 发布 ")])),_:1})])]),default:l(()=>[t(z,{model:d,rules:W,ref_key:"publishFormRef",ref:Y},{default:l(()=>[t(h,{label:"作业标题",prop:"title"},{default:l(()=>[t(F,{modelValue:d.title,"onUpdate:modelValue":e[2]||(e[2]=a=>d.title=a),placeholder:"请输入作业标题"},null,8,["modelValue"])]),_:1}),t(h,{label:"作业说明",prop:"description"},{default:l(()=>[t(F,{modelValue:d.description,"onUpdate:modelValue":e[3]||(e[3]=a=>d.description=a),type:"textarea",rows:"4",placeholder:"请输入作业说明"},null,8,["modelValue"])]),_:1}),t(h,{label:"截止日期",prop:"deadline"},{default:l(()=>[t(ve,{modelValue:d.deadline,"onUpdate:modelValue":e[4]||(e[4]=a=>d.deadline=a),type:"datetime",placeholder:"选择截止日期",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm","disabled-date":ae},null,8,["modelValue"])]),_:1}),t(h,{label:"文件格式"},{default:l(()=>[t(ge,{modelValue:d.fileFormat,"onUpdate:modelValue":e[5]||(e[5]=a=>d.fileFormat=a)},{default:l(()=>[t(N,{label:"pdf"},{default:l(()=>e[20]||(e[20]=[m("仅PDF")])),_:1}),t(N,{label:"any"},{default:l(()=>e[21]||(e[21]=[m("不限格式")])),_:1})]),_:1},8,["modelValue"])]),_:1}),t(h,{label:"提交控制"},{default:l(()=>[t(g,{modelValue:d.allowSubmit,"onUpdate:modelValue":e[6]||(e[6]=a=>d.allowSubmit=a),"active-text":"允许提交","inactive-text":"禁止提交"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(j,{modelValue:S.value,"onUpdate:modelValue":e[11]||(e[11]=a=>S.value=a),title:"添加反馈",width:"500px"},{footer:l(()=>[f("span",Re,[t(n,{onClick:e[10]||(e[10]=a=>S.value=!1)},{default:l(()=>e[24]||(e[24]=[m("取消")])),_:1}),t(n,{type:"primary",onClick:me},{default:l(()=>e[25]||(e[25]=[m(" 确认 ")])),_:1})])]),default:l(()=>[t(z,{model:k.value},{default:l(()=>[t(h,{label:"反馈内容","label-width":"100px"},{default:l(()=>[t(F,{modelValue:k.value.content,"onUpdate:modelValue":e[9]||(e[9]=a=>k.value.content=a),type:"textarea",rows:"4",placeholder:"请输入反馈内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ee=Ce(Ae,[["__scopeId","data-v-eba6035a"]]);export{Ee as default};
